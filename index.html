<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color1: #1e1e2e; /* Background - dark muted blue */
            --color2: #6c7086; /* Comment - medium desaturated blue */
            --color3: #313244; /* Selection - dark muted blue */
            --color0: #181825; /* Darker background - darker gray/purple */
            --color4: #cdd6f4; /* Foreground - off-white/light cream */
            --color5: #89b4fa; /* Cyan - bright light blue */
            --color6: #a6e3a1; /* Green - vibrant bright lime green */
            --color7: #fab387; /* Orange - soft pastel orange */
            --color8: #f5c2e7; /* Pink - bright vivid hot pink */
            --color9: #cba6f7; /* Purple - light pastel lavender */
            --color10: #f38ba8; /* Red - bright warm red/coral */
            --color11: #f9e2af; /* Yellow - very pale soft yellow */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--color0);
            color: var(--color4);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: transparent;
            color: var(--color5);
            padding: 0.625rem 1.25rem;
            border-bottom: 1px solid var(--color2);
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: 0.03rem;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: minmax(0, 1fr) minmax(0, 1fr);
            height: calc(100vh - 56px);
            gap: 0;
            flex: 1;
            min-height: 0;
        }
        
        .top-left {
            grid-column: 1;
            grid-row: 1;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: minmax(0, auto) minmax(0, auto) minmax(0, auto) minmax(0, 1fr);
            gap: 0;
            min-height: 0;
        }
        
        .timer-section {
            grid-column: 1;
            grid-row: 1;
            background: transparent;
            padding: 0.5rem 1rem;
            border-right: 1px solid var(--color2);
            border-bottom: 1px solid var(--color2);
            transition: box-shadow 0.3s;
            position: relative;
        }
        
        .timer-section.highlighted {
            box-shadow: inset 0 0 0 2px var(--color5);
            animation: pulse 2s ease-in-out 3;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: inset 0 0 0 2px var(--color5);
            }
            50% {
                box-shadow: inset 0 0 0 2px var(--color5);
            }
        }
        
        .task-section {
            grid-column: 1;
            grid-row: 2;
            background: transparent;
            padding: 0.5rem 1rem;
            border-right: 1px solid var(--color2);
            border-bottom: 1px solid var(--color2);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .timezone-section {
            grid-column: 1;
            grid-row: 3 / -1;
            background: transparent;
            padding: 0.5rem 1rem;
            border-right: 1px solid var(--color2);
            border-bottom: 1px solid var(--color2);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .timezone-list {
            width: 100%;
        }
        
        .timezone-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .timezone-table td {
            padding: 0.25rem 0;
            color: var(--color4);
            vertical-align: top;
        }
        
        .timezone-table td:first-child {
            padding-right: 0.75rem;
            color: var(--color4);
        }
        
        .timezone-table td:last-child {
            color: var(--color4);
        }
        
        .timezone-pin {
            cursor: pointer;
            color: var(--color2);
            font-size: 0.75rem;
            padding-left: 0.5rem;
            transition: color 0.2s;
        }
        
        .timezone-pin:hover {
            color: var(--color5);
        }
        
        .timezone-pin.pinned {
            color: var(--color6);
        }
        
        .timezone-pin i {
            font-size: 0.75rem;
        }
        
        .timezone-table tr:has(.timezone-pin.pinned) td {
            color: var(--color6);
        }
        
        .timezone-table tr:has(.timezone-pin.pinned) .timezone-offset {
            color: var(--color6);
        }
        
        .timezone-separator {
            animation: timezonePulse 1s ease-in-out infinite;
        }
        
        @keyframes timezonePulse {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 1;
            }
        }
        
        .timezone-offset {
            color: var(--color9);
            margin-left: 0.25rem;
        }
        
        /* Unified helper text class for consistent styling */
        .helper-text {
            color: var(--color2);
            font-style: italic;
            font-size: 0.75rem;
        }
        
        .timezone-empty {
            padding: 0.5rem 0;
        }
        
        .links-section {
            grid-column: 2;
            grid-row: 1 / 5;
            background: transparent;
            border-right: 1px solid var(--color2);
            border-bottom: 1px solid var(--color2);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .links-section .section-header {
            padding: 0.5rem 1rem;
        }
        
        .links-section .links-container {
            padding: 0 1rem 0.5rem 1rem;
        }
        
        .emotion-section {
            grid-column: 3;
            grid-row: 1 / 3;
            background: transparent;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--color2);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .tactics-section {
            grid-column: 3;
            grid-row: 3 / 5;
            background: transparent;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--color2);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .tactics-display {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.875rem;
            color: var(--color4);
            font-family: 'JetBrains Mono', monospace;
            padding: 0.625rem;
            line-height: 1.5;
        }
        
        .emotion-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-bottom: 0.625rem;
        }
        
        .emotion-btn {
            padding: 0.25rem 0.5rem;
            background: var(--color1);
            border: 1px solid var(--color2);
            border-radius: 0.1875rem;
            color: var(--color4);
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            white-space: nowrap;
            width: auto;
        }
        
        .emotion-btn:hover:not(.selected):not(.disabled) {
            background: var(--color3);
            border-color: var(--color5);
        }
        
        .emotion-btn.selected {
            background: var(--color6) !important;
            border-color: var(--color6) !important;
            color: var(--color1) !important;
            font-weight: 600 !important;
        }
        
        .emotion-btn.selected:hover {
            background: var(--color6) !important;
            border-color: var(--color6) !important;
        }
        
        .emotion-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .emotion-input {
            width: 100%;
            padding: 0.5rem 0.625rem;
            border: 1px solid var(--color2);
            border-radius: 0.1875rem;
            background: var(--color1);
            color: var(--color4);
            font-size: 0.8125rem;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.625rem;
            resize: vertical;
            min-height: 3rem;
            max-height: 6rem;
            box-sizing: border-box;
        }
        
        .emotion-input:focus {
            outline: none;
            border-color: var(--color5);
        }
        
        /* Primary action button - reusable for log, accept, etc. */
        .primary-btn {
            padding: 0.25rem 0.5rem;
            background: var(--color6);
            border: 1px solid var(--color6);
            border-radius: 0.1875rem;
            color: var(--color1);
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: background 0.2s;
            text-align: left;
            width: auto;
            display: inline-block;
            align-self: flex-start; /* Prevents stretching in flex containers */
        }
        
        .primary-btn:hover {
            background: var(--color6);
            opacity: 0.9;
        }
        
        .primary-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--color2);
            border-color: var(--color2);
            color: var(--color4);
        }
        
        .primary-btn:hover:not(:disabled) {
            background: var(--color7);
            border-color: var(--color7);
        }
        
        .trello-section {
            grid-column: 1;
            grid-row: 2;
            background: transparent;
            border-right: 1px solid var(--color2);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .trello-section iframe {
            width: 100%;
            flex: 1;
            border: none;
            min-height: 0;
            display: block;
        }
        
        .trello-eye-container {
            flex-shrink: 0;
            padding: 0.5rem 1rem;
            padding-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }
        
        .notes-section {
            grid-column: 2;
            grid-row: 1;
            background: transparent;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--color2);
            border-bottom: 1px solid var(--color2);
            overflow: hidden;
            max-height: 100%;
            position: relative;
        }
        
        .trello-section {
            grid-column: 1;
            grid-row: 2;
            background: transparent;
            border-right: 1px solid var(--color2);
            overflow: hidden;
            position: relative;
        }
        
        .projects-section {
            grid-column: 2;
            grid-row: 2;
            background: transparent;
            border-right: 1px solid var(--color2);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .projects-section .section-header {
            padding: 0.5rem 1rem;
        }
        
        .projects-section .links-container {
            padding: 0 1rem 0.5rem 1rem;
        }
        
        h2 {
            margin-bottom: 0.625rem;
            color: var(--color5);
            font-size: 1rem;
            font-weight: 600;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.625rem;
            flex-shrink: 0;
        }
        
        .section-header h2 {
            margin-bottom: 0;
        }
        
        .icon-container {
            width: 1rem;
            height: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .panel-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .icon-container i {
            font-size: 0.75rem;
            color: var(--color2);
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .icon-container i:hover {
            color: var(--color5);
        }
        
        .eye-icon {
            display: inline-flex;
            align-items: center;
        }
        
        .panel-blur-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 10;
            display: none;
            pointer-events: none;
        }
        
        .panel-section.blurred .panel-blur-overlay {
            display: block;
        }
        
        .panel-section.blurred {
            filter: blur(4px);
        }
        
        .panel-section.blurred .panel-blur-overlay {
            filter: none;
        }
        
        .config-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--color2);
            font-size: 1rem;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .config-link .icon-container {
            width: 1rem;
            height: 1rem;
        }
        
        .config-link i {
            font-size: 0.75rem;
            display: inline-block;
            color: var(--color2);
        }
        
        .config-link:hover {
            color: var(--color2);
            opacity: 0.8;
        }
        
        /* Timer Section */
        .timer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.625rem;
        }
        
        .timer-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .timer-header h2 {
            margin-bottom: 0;
        }
        
        .mute-toggle {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: opacity 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--color2);
            width: 1rem;
            height: 1rem;
        }
        
        .mute-toggle i {
            font-size: 0.75rem;
            display: inline-block;
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            line-height: 1;
        }
        
        .mute-toggle:hover {
            background: transparent;
            color: var(--color2);
        }
        
        .mute-toggle.muted {
            opacity: 0.4;
        }
        
        .activity-bars {
            display: flex;
            gap: 0.125rem;
            align-items: center;
        }
        
        .activity-bar {
            width: 0.1875rem;
            height: 1.25rem;
            background: var(--color2);
            border-radius: 0.0625rem;
            transition: background 0.2s;
        }
        
        /* Timer duration colors */
        .activity-bar.timer-5 {
            background: var(--color5);  /* Cyan - 5 min */
        }
        
        .activity-bar.timer-15 {
            background: var(--color5);  /* Cyan - 15 min */
            opacity: 0.8;
        }
        
        .activity-bar.timer-30 {
            background: var(--color9);  /* Purple - 30 min */
            opacity: 0.8;
        }
        
        .activity-bar.timer-45 {
            background: var(--color9);  /* Purple - 45 min */
        }
        
        .activity-bar.timer-60 {
            background: var(--color9);  /* Purple - 60 min */
        }
        
        .activity-bar.timer-custom {
            background: var(--color7);  /* Orange - custom */
        }
        
        .timer-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-bottom: 0.625rem;
        }
        
        .timer-preset {
            padding: 0.125rem 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            height: auto;
            min-height: 2.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.125rem;
            position: relative;
            border: 0.09375rem solid var(--timer-accent, var(--color5));
            border-radius: 0.1875rem;
            background: transparent;
            color: var(--timer-accent, var(--color5));
            transition: background 0.2s, opacity 0.2s, color 0.2s, box-shadow 0.2s;
        }
        
        .timer-preset .timer-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.125rem;
        }
        
        .timer-preset .timer-duration {
            font-size: 1rem;
            font-weight: 600;
            line-height: 1;
        }
        
        .timer-preset .timer-unit {
            font-size: 0.5rem;
            opacity: 0.8;
            line-height: 1;
        }
        
        .timer-preset .timer-display {
            display: none;
            font-size: 1rem;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            line-height: 1;
        }
        
        .timer-preset .timer-reset {
            display: none;
            font-size: 0.5rem;
            opacity: 0.7;
            position: absolute;
            bottom: 0.25rem;
        }
        
        .timer-preset:hover:not(.inactive) {
            background-color: var(--timer-accent, var(--color5)) !important;
            color: var(--color1) !important;
            border-color: var(--timer-accent, var(--color5));
            box-shadow: 0 0 0 1px var(--timer-accent, var(--color5));
        }
        
        .timer-preset:hover:not(.inactive) .timer-duration,
        .timer-preset:hover:not(.inactive) .timer-unit {
            color: var(--color1) !important;
            opacity: 1;
        }
        
        .timer-preset.custom-timer-btn:hover:not(.inactive) .timer-duration {
            color: var(--color1) !important;
        }
        
        .timer-preset.active .timer-label {
            display: none;
        }
        
        .timer-preset.active .timer-display {
            display: block;
        }
        
        .timer-preset.active {
            background: var(--timer-accent, var(--color5));
            color: var(--color1);
            border-color: var(--timer-accent, var(--color5));
            box-shadow: none;
        }
        
        /* Keep timer-label visible for custom timer when active */
        .timer-preset.custom-timer-btn.active .timer-label {
            display: flex;
        }
        
        .timer-preset.custom-timer-btn.active .timer-display {
            display: none;
        }
        
        /* Hide "minutes" text when custom timer is active */
        .timer-preset.custom-timer-btn.active .timer-unit {
            display: none;
        }
        
        .timer-preset.custom-timer-btn.active .timer-duration {
            color: var(--color1);
        }
        
        .timer-preset.task-highlighted {
            box-shadow: 0 0 0 2px var(--color5);
            animation: timerPulse 1s ease-in-out infinite;
        }
        
        @keyframes timerPulse {
            0%, 100% {
                box-shadow: 0 0 0 2px var(--color5);
            }
            50% {
                box-shadow: 0 0 0 4px var(--color5);
            }
        }
        
        .timer-preset.paused .timer-reset {
            display: block;
        }
        
        .timer-preset.inactive {
            background: transparent !important;
            border-color: var(--color2);
            color: var(--color2);
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .timer-preset[data-minutes="5"] {
            --timer-accent: var(--color5);
        }
        
        .timer-preset[data-minutes="15"] {
            --timer-accent: var(--color6);
        }
        
        .timer-preset[data-minutes="30"] {
            --timer-accent: var(--color7);
        }
        
        .timer-preset[data-minutes="45"] {
            --timer-accent: var(--color8);
        }
        
        .timer-preset[data-minutes="60"] {
            --timer-accent: var(--color9);
        }
        
        .timer-preset.custom-timer-btn {
            --timer-accent: var(--color10);
            padding: 0.125rem 0.375rem;
        }
        
        .custom-timer-btn .timer-duration {
            font-size: 1rem;
            font-weight: 600;
            line-height: 1;
            color: var(--timer-accent, var(--color10));
            outline: none;
            text-align: center;
        }
        
        .custom-timer-btn .timer-duration:focus {
            color: rgba(13, 17, 23, 0.8);
        }
        
        .custom-timer-btn.active .timer-duration {
            color: inherit;
            pointer-events: none;
        }
        
        .custom-timer-btn .timer-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.125rem;
        }
        
        .custom-timer-btn.active .timer-label {
            display: flex;
        }
        
        .custom-timer-btn .timer-unit {
            font-size: 0.5rem;
            opacity: 0.8;
            line-height: 1;
        }
        
        .custom-timer-btn.inactive {
            background: var(--color3) !important;
            color: var(--color2);
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .custom-timer-btn.inactive input {
            cursor: not-allowed;
        }
        
        /* Task Picker Section */
        .task-display {
            flex: 1;
            /* background: var(--color1); */
            background: transparent;
            border: none;
            border-radius: 0.1875rem;
            padding: 0;
            margin-bottom: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            text-align: left;
            font-size: 0.875rem;
            line-height: 1.4;
            color: var(--color4);
            min-height: 5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .task-display:hover {
            /* background: var(--color3); */
            background: transparent;
        }
        
        
        .task-display.has-task {
            cursor: pointer;
        }
        
        .task-display.has-task:hover {
            /* background: var(--color3); */
            background: transparent;
        }
        
        .task-display.has-task:has(#taskDoneLink),
        .task-display.has-task:has(#taskCancelledLink) {
            cursor: default;
        }
        
        .task-display.has-task:has(#taskDoneLink):hover,
        .task-display.has-task:has(#taskCancelledLink):hover {
            /* background: var(--color1); */
            background: transparent;
        }
        
        .task-display.loading {
            justify-content: center;
            align-items: center;
        }
        
        .task-spinner {
            display: none;
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid var(--color2);
            border-top-color: var(--color5);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        .task-display.loading .task-spinner {
            display: block;
        }
        
        .task-display.loading span:not(.task-spinner) {
            display: none;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .task-actions {
            display: flex;
            gap: 0.375rem;
            justify-content: flex-start;
            margin-bottom: 0.625rem;
        }
        
        .task-controls {
            display: flex;
            gap: 0.375rem;
            flex-direction: column;
        }
        
        .task-duration-presets {
            margin-bottom: 0.375rem;
        }
        
        .task-duration-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.375rem;
        }
        
        .task-duration-btn {
            padding: 0.375rem 0.5rem;
            background: transparent;
            border: 0.09375rem solid var(--timer-accent, var(--color5));
            border-radius: 0.1875rem;
            color: var(--timer-accent, var(--color5));
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            height: 2rem;
            font-weight: 600;
        }
        
        .task-duration-btn[data-duration="5"] {
            --timer-accent: var(--color5);
        }
        
        .task-duration-btn[data-duration="15"] {
            --timer-accent: var(--color6);
        }
        
        .task-duration-btn[data-duration="30"] {
            --timer-accent: var(--color7);
        }
        
        .task-duration-btn[data-duration="45"] {
            --timer-accent: var(--color8);
        }
        
        .task-duration-btn[data-duration="60"] {
            --timer-accent: var(--color9);
        }
        
        .task-duration-btn.custom {
            --timer-accent: var(--color10);
        }
        
        .task-duration-btn:hover:not(.selected) {
            background: var(--color3);
            opacity: 0.8;
        }
        
        .task-duration-btn.selected {
            background: var(--timer-accent, var(--color5));
            border-color: var(--timer-accent, var(--color5));
            color: var(--color1);
        }
        
        .task-duration-btn.custom.selected {
            background: var(--color10);
            border-color: var(--color10);
            color: var(--color1);
        }
        
        .task-input-group {
            display: flex;
            gap: 0.375rem;
        }
        
        .task-input-group input {
            flex: 1;
            padding: 0.5rem 0.625rem;
            border: 1px solid var(--color2);
            border-radius: 0.1875rem;
            font-size: 0.8125rem;
            background: var(--color1);
            color: var(--color4);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .task-input-group input:focus {
            outline: none;
            border-color: var(--color5);
        }
        
        .task-input-group button {
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
        }
        
        .task-list {
            max-height: 7.5rem;
            overflow-y: auto;
            margin-top: 0.375rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.375rem 0.5rem;
            background: var(--color1);
            border-radius: 0.1875rem;
            border: 1px solid var(--color2);
            font-size: 0.75rem;
        }
        
        .task-item span {
            flex: 1;
            margin-right: 0.5rem;
        }
        
        /* .task-item button {
            padding: 0.25rem 0.625rem;
            font-size: 0.6875rem;
        } */
        
        /* Quick Links Section */
        .links-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(5rem, 1fr));
            gap: 0.375rem;
            grid-auto-rows: auto;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }
        
        .timezone-config-group {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        
        .timezone-config-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 0.75rem;
        }
        
        .timezone-config-item select {
            padding: 0.5rem 0.625rem;
            border: 1px solid var(--color2);
            border-radius: 0.1875rem;
            font-size: 0.8125rem;
            background: var(--color1);
            color: var(--color4);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .timezone-config-item select:focus {
            outline: none;
            border-color: var(--color5);
        }
        
        .timezone-config-item input {
            padding: 0.5rem 0.625rem;
            border: 1px solid var(--color2);
            border-radius: 0.1875rem;
            font-size: 0.8125rem;
            background: var(--color1);
            color: var(--color4);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .timezone-config-item input:focus {
            outline: none;
            border-color: var(--color5);
        }
        
        .link-input-group {
            display: flex;
            gap: 0.375rem;
            margin-bottom: 0.625rem;
            flex-direction: column;
        }
        
        .link-input-group input {
            padding: 0.5rem 0.625rem;
            border: 1px solid var(--color2);
            border-radius: 0.1875rem;
            font-size: 0.8125rem;
            background: var(--color1);
            color: var(--color4);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .link-input-group input:focus {
            outline: none;
            border-color: var(--color5);
        }
        
        .link-input-row {
            display: flex;
            gap: 0.375rem;
        }
        
        .link-input-row input {
            flex: 1;
        }
        
        .link-input-row button {
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
        }
        
        .link-input-row button.primary-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .link-item {
            padding: 10px 12px;
            background: transparent;
            border-radius: 3px;
            border: 1px solid var(--color6);
            transition: border-color 0.2s, color 0.2s;
            text-align: center;
            font-size: 12px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            aspect-ratio: 1.2;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--color6);
            font-family: 'JetBrains Mono', monospace;
            text-decoration: none;
        }
        
        .link-item:hover {
            border-color: var(--color6);
            opacity: 0.8;
            text-decoration: none;
        }
        
        .link-item.empty {
            border-color: var(--color2);
            color: var(--color2);
            cursor: default;
        }
        
        .link-item.empty:hover {
            border-color: var(--color2);
            color: var(--color2);
            opacity: 1;
        }
        
        /* Buttons */
        button {
            padding: 10px 24px;
            border: none;
            border-radius: 3px;
            background: var(--color6);
            color: var(--color4);
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
        }
        
        button:hover {
            background: var(--color6);
        }
        
        button.secondary {
            background: var(--color3);
            border: 1px solid var(--color2);
        }
        
        button.secondary:hover {
            background: var(--color2);
        }
        
        button.danger {
            background: var(--color10);
        }
        
        button.danger:hover {
            background: var(--color10);
            opacity: 0.9;
        }
        
        button.danger.icon-button {
            background: transparent;
        }
        
        button.danger.icon-button:hover {
            background: transparent;
            opacity: 1;
        }
        
        button.danger.icon-button i {
            color: var(--color10);
        }
        
        button.danger.icon-button:hover i {
            color: var(--color10);
            opacity: 0.8;
        }
        
        button.success {
            background: var(--color6);
        }
        
        button.success:hover {
            background: var(--color6);
            opacity: 0.9;
        }
        
        .icon-button {
            padding: 0.25rem;
            width: 1.5rem;
            height: 1.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.1875rem;
            font-size: 0.875rem;
        }
        
        .icon-button i {
            font-size: 0.625rem;
            pointer-events: none;
            display: inline-block;
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            line-height: 1;
        }
        
        /* CodeMirror customization */
        .CodeMirror {
            height: 100% !important;
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            background: var(--color1);
        }
        
        .CodeMirror-scroll {
            overflow-y: auto !important;
            overflow-x: hidden !important;
            max-height: 100%;
            direction: rtl;  /* Moves scrollbar to left */
        }
        
        .CodeMirror-scroll > * {
            direction: ltr;  /* Restore normal text direction */
        }
        
        .CodeMirror-gutters {
            background: var(--color1);
            border-right: 1px solid var(--color2);
        }
        
        .CodeMirror-linenumber {
            color: var(--color2);
            padding: 0 8px 0 5px;
        }
        
        #editor-container {
            flex: 1;
            overflow: hidden;
            height: 100%;
            min-height: 0;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--color1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--color2);
            border-radius: 2.5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color2);
            opacity: 0.8;
        }

.modal {
    display: none; /* Hidden by default */
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.6);
}

.modal-content {
    background-color: var(--color3);
    margin: 10% auto;
    padding: 1.25rem;
    border: 1px solid var(--color2);
    width: 90%;
    max-width: 28rem;
    color: var(--color4);
    border-radius: 0.1875rem;
}

.modal-content h2 {
    margin-bottom: 1rem;
    color: var(--color5);
    font-size: 1rem;
    font-weight: 600;
}

.close {
    color: var(--color2);
    float: right;
    font-size: 1.5rem;
    font-weight: bold;
    line-height: 1;
    cursor: pointer;
    transition: color 0.2s;
}

.close:hover,
.close:focus {
    color: var(--color4);
    text-decoration: none;
    cursor: pointer;
}

.links-list {
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 18.75rem;
    overflow-y: auto;
    padding: 0.5rem;
    background: var(--color1);
    border-radius: 0.1875rem;
    border: 1px solid var(--color2);
}

.links-list .link-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.375rem 0.5rem;
    background: var(--color3);
    border-radius: 0.1875rem;
    border: 1px solid var(--color2);
    gap: 0.75rem;
    min-height: auto;
    aspect-ratio: auto;
    width: auto;
    height: auto;
    white-space: normal;
    text-align: left;
}

.links-list .link-item a {
    flex: 1;
    color: var(--color5);
    text-decoration: none;
    font-size: 0.875rem;
}

.links-list .link-item a:hover {
    color: var(--color5);
    opacity: 0.8;
}

    </style>
</head>
<body>
    <div class="header">
        <span>Control Panel</span>
        <a href="#" class="config-link" onclick="showDataManagement(); return false;" aria-label="Data management">
            <div class="icon-container">
                <i class="fa-solid fa-gear" aria-hidden="true"></i>
            </div>
        </a>
    </div>
    <div class="layout">
        <!-- Top Left: Timer, Tasks, Links -->
        <div class="top-left">
            <!-- Timer Section -->
            <div class="timer-section panel-section">
                <div class="panel-blur-overlay"></div>
                <div class="timer-header">
                    <div class="timer-header-left">
                        <div class="panel-toggle">
                            <div class="icon-container">
                                <i class="fa-solid fa-eye eye-icon" onclick="togglePanelBlur('timer-section')" aria-label="Toggle blur"></i>
                            </div>
                <h2>Timer</h2>
                </div>
                        <div class="activity-bars" id="activityBars"></div>
                    </div>
                    <button id="muteToggle" class="mute-toggle" onclick="toggleMute()" title="Mute timer" aria-label="Mute timer">
                        <i class="fa-solid fa-bell" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="timer-presets">
                    <button class="timer-preset" data-minutes="5" onclick="handleTimerClick(5, this)">
                        <span class="timer-label">
                            <span class="timer-duration">05</span>
                        </span>
                        <span class="timer-display"></span>
                        <span class="timer-reset">reset</span>
                    </button>
                    <button class="timer-preset" data-minutes="15" onclick="handleTimerClick(15, this)">
                        <span class="timer-label">
                            <span class="timer-duration">15</span>
                        </span>
                        <span class="timer-display"></span>
                        <span class="timer-reset">reset</span>
                    </button>
                    <button class="timer-preset" data-minutes="30" onclick="handleTimerClick(30, this)">
                        <span class="timer-label">
                            <span class="timer-duration">30</span>
                        </span>
                        <span class="timer-display"></span>
                        <span class="timer-reset">reset</span>
                    </button>
                    <button class="timer-preset" data-minutes="45" onclick="handleTimerClick(45, this)">
                        <span class="timer-label">
                            <span class="timer-duration">45</span>
                        </span>
                        <span class="timer-display"></span>
                        <span class="timer-reset">reset</span>
                    </button>
                    <button class="timer-preset" data-minutes="60" onclick="handleTimerClick(60, this)">
                        <span class="timer-label">
                            <span class="timer-duration">60</span>
                        </span>
                        <span class="timer-display"></span>
                        <span class="timer-reset">reset</span>
                    </button>
                    <button class="timer-preset custom-timer-btn" onclick="handleCustomTimerClick()">
                        <span class="timer-label">
                            <span class="timer-duration" contenteditable="true" data-placeholder="XX">XX</span>
                        </span>
                        <span class="timer-display"></span>
                        <span class="timer-reset">reset</span>
                    </button>
                </div>
            </div>
            
            <!-- Task Picker Section -->
            <div class="task-section panel-section">
                <div class="panel-blur-overlay"></div>
                <div class="section-header">
                <div class="panel-toggle">
                    <div class="icon-container">
                        <i class="fa-solid fa-eye eye-icon" onclick="togglePanelBlur('task-section')" aria-label="Toggle blur"></i>
                    </div>
                <h2>Quick Tasks</h2>
                </div>
                    <a href="#" class="config-link" onclick="showTaskConfig(); return false;" aria-label="Configure tasks">
                        <div class="icon-container">
                            <i class="fa-solid fa-gear" aria-hidden="true"></i>
                        </div>
                    </a>
                </div>
                <div class="task-display" id="taskDisplay">
                    <span class="empty helper-text">Click to pick a task</span>
                    <span class="task-spinner"></span>
                </div>
                <div class="task-actions" id="taskActions">
                    <button class="primary-btn" id="acceptTaskBtn" onclick="acceptTask()" disabled>Accept</button>
                </div>
            </div>

            <!-- Timezone Section -->
            <div class="timezone-section panel-section">
                <div class="panel-blur-overlay"></div>
                <div class="section-header">
                    <div class="panel-toggle">
                        <div class="icon-container">
                            <i class="fa-solid fa-eye eye-icon" onclick="togglePanelBlur('timezone-section')" aria-label="Toggle blur"></i>
                        </div>
                        <h2>Time zones</h2>
                    </div>
                    <a href="#" class="config-link" onclick="showTimezoneConfig(); return false;" aria-label="Configure timezones">
                        <div class="icon-container">
                            <i class="fa-solid fa-gear" aria-hidden="true"></i>
                        </div>
                    </a>
                </div>
                <div class="timezone-list" id="timezoneList">
                    <!-- Timezone table will be rendered here -->
                </div>
            </div>

            <!-- Task Config Modal -->
            <div id="taskConfigModal" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                    <span class="close" onclick="hideTaskConfig()">&times;</span>
                    <h2>Configure Tasks</h2>
                <div class="task-controls">
                    <div class="task-input-group">
                            <input type="text" id="taskInput" placeholder="Task name...">
                        </div>
                        <div class="task-duration-presets">
                            <label style="font-size: 0.75rem; color: var(--color2); margin-bottom: 0.375rem; display: block;">Duration:</label>
                            <div class="task-duration-buttons">
                                <button class="task-duration-btn" data-duration="5" onclick="selectTaskDuration(5)">5</button>
                                <button class="task-duration-btn" data-duration="15" onclick="selectTaskDuration(15)">15</button>
                                <button class="task-duration-btn" data-duration="30" onclick="selectTaskDuration(30)">30</button>
                                <button class="task-duration-btn" data-duration="45" onclick="selectTaskDuration(45)">45</button>
                                <button class="task-duration-btn" data-duration="60" onclick="selectTaskDuration(60)">60</button>
                                <button class="task-duration-btn custom" data-duration="custom" onclick="selectTaskDuration('custom')">Custom</button>
                            </div>
                            <input type="number" id="taskDurationCustom" placeholder="min" min="1" max="999" style="display: none; margin-top: 0.375rem; padding: 0.375rem 0.5rem; border: 1px solid var(--color2); border-radius: 0.1875rem; background: var(--color1); color: var(--color4); font-size: 0.75rem; font-family: 'JetBrains Mono', monospace;">
                        </div>
                        <div class="task-input-group">
                            <input type="text" id="taskTags" placeholder="Tags (comma-separated, e.g., urgent,work)">
                        </div>
                        <div class="task-input-group">
                        <button class="primary-btn" onclick="addTask()">Add</button>
                    </div>
                    <div class="task-list" id="taskList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Links Section -->
            <div class="links-section panel-section">
                <div class="panel-blur-overlay"></div>
                <div class="section-header">
                <div class="panel-toggle">
                    <div class="icon-container">
                        <i class="fa-solid fa-eye eye-icon" onclick="togglePanelBlur('links-section')" aria-label="Toggle blur"></i>
                    </div>
                <h2>Quick Links</h2>
                </div>
                    <a href="#" class="config-link" onclick="showLinkConfig(); return false;" aria-label="Configure quick links">
                        <div class="icon-container">
                            <i class="fa-solid fa-gear" aria-hidden="true"></i>
                        </div>
                    </a>
                </div>
                <div class="links-container" id="linksContainer">
                    <!-- Links will be shown here -->
                </div>
            </div>
            
            <!-- Emotional Tracker Section -->
            <div class="emotion-section panel-section">
                <div class="panel-blur-overlay"></div>
                <div class="section-header">
                    <div class="panel-toggle">
                        <div class="icon-container">
                            <i class="fa-solid fa-eye eye-icon" onclick="togglePanelBlur('emotion-section')" aria-label="Toggle blur"></i>
                        </div>
                        <h2>Emotional Tracker</h2>
                    </div>
                </div>
                <div class="emotion-buttons">
                    <button class="emotion-btn" data-emotion="contempt" onclick="toggleEmotion('contempt')">Contempt</button>
                    <button class="emotion-btn" data-emotion="happiness" onclick="toggleEmotion('happiness')">Happiness</button>
                    <button class="emotion-btn" data-emotion="anger" onclick="toggleEmotion('anger')">Anger</button>
                    <button class="emotion-btn" data-emotion="disgust" onclick="toggleEmotion('disgust')">Disgust</button>
                    <button class="emotion-btn" data-emotion="surprise" onclick="toggleEmotion('surprise')">Surprise</button>
                    <button class="emotion-btn" data-emotion="fear" onclick="toggleEmotion('fear')">Fear</button>
                    <button class="emotion-btn" data-emotion="sadness" onclick="toggleEmotion('sadness')">Sadness</button>
                </div>
                <textarea 
                    id="emotionInput" 
                    class="emotion-input" 
                    placeholder="Explain your emotions (max 120 characters)"
                    maxlength="120"
                ></textarea>
                <button class="primary-btn" id="logEmotionBtn" onclick="logEmotion()" disabled>Log</button>
            </div>

            <!-- Tactics Section -->
            <div class="tactics-section panel-section">
                <div class="panel-blur-overlay"></div>
                <div class="section-header">
                    <div class="panel-toggle">
                        <div class="icon-container">
                            <i class="fa-solid fa-eye eye-icon" onclick="togglePanelBlur('tactics-section')" aria-label="Toggle blur"></i>
                        </div>
                        <h2>Tactics</h2>
                    </div>
                    <a href="#" class="config-link" onclick="showTacticsConfig(); return false;" aria-label="Configure tactics">
                        <div class="icon-container">
                            <i class="fa-solid fa-gear" aria-hidden="true"></i>
                        </div>
                    </a>
                </div>
                <div class="tactics-display" id="tacticsDisplay">
                    <!-- Tactic will be displayed here -->
                </div>
            </div>

            <!-- Link Config Modal -->
            <div id="linkConfigModal" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                    <span class="close" onclick="hideLinkConfig()">&times;</span>
                    <h2>Configure Links</h2>
                <div class="link-input-group">
                    <input type="text" id="linkName" placeholder="Name">
                    <div class="link-input-row">
                        <input type="url" id="linkUrl" placeholder="https://example.com">
                        <button class="primary-btn" onclick="addLink()">Add</button>
                    </div>
                </div>
                    <div class="links-list" id="linksList"></div>
                </div>
            </div>
        </div>
        
        <!-- Notes Section -->
        <div class="notes-section panel-section">
            <div class="panel-blur-overlay"></div>
            <div class="section-header" style="padding: 1rem; padding-bottom: 0.5rem;">
                <div class="panel-toggle">
                    <div class="icon-container">
                        <i class="fa-solid fa-eye eye-icon" onclick="togglePanelBlur('notes-section')" aria-label="Toggle blur"></i>
                    </div>
                    <h2>Notes</h2>
                </div>
                <div class="icon-container">
                    <i class="fa-solid fa-copy" onclick="copyNotes()" aria-label="Copy notes"></i>
                </div>
            </div>
            <div id="editor-container"></div>
        </div>
        
        <!-- Trello Board Section -->
        <div class="trello-section panel-section">
            <div class="panel-blur-overlay"></div>
            <div class="trello-eye-container">
                <div class="icon-container">
                    <i class="fa-solid fa-eye eye-icon" onclick="togglePanelBlur('trello-section')" aria-label="Toggle blur"></i>
                </div>
            </div>
            <iframe src="https://trello.com/b/8ZNahQ9V.html"></iframe>
        </div>
        
        <!-- Projects Section -->
        <div class="projects-section panel-section">
            <div class="panel-blur-overlay"></div>
            <div class="section-header">
                <div class="panel-toggle">
                    <div class="icon-container">
                        <i class="fa-solid fa-eye eye-icon" onclick="togglePanelBlur('projects-section')" aria-label="Toggle blur"></i>
                    </div>
                    <h2>Projects</h2>
                </div>
                <a href="#" class="config-link" onclick="showProjectConfig(); return false;" aria-label="Configure projects">
                    <div class="icon-container">
                        <i class="fa-solid fa-gear" aria-hidden="true"></i>
                    </div>
                </a>
            </div>
            <div class="links-container" id="projectsContainer">
                <!-- Projects will be shown here -->
            </div>
        </div>

        <!-- Projects Config Modal -->
        <div id="projectConfigModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="hideProjectConfig()">&times;</span>
                <h2>Configure Projects</h2>
                <div class="link-input-group">
                    <input type="text" id="projectName" placeholder="Name">
                    <div class="link-input-row">
                        <input type="url" id="projectUrl" placeholder="https://example.com">
                        <button class="primary-btn" onclick="addProject()">Add</button>
                    </div>
                </div>
                <div class="links-list" id="projectsList"></div>
            </div>
        </div>

        <!-- Timezone Config Modal -->
        <div id="timezoneConfigModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="hideTimezoneConfig()">&times;</span>
                <h2>Configure Time zones</h2>
                <div class="timezone-config-group">
                    <div class="timezone-config-item">
                        <label style="font-size: 0.75rem; color: var(--color2); margin-bottom: 0.25rem; display: block;">Timezone 1:</label>
                        <input type="text" id="timezone1Label" placeholder="Label" style="margin-bottom: 0.375rem;">
                        <select id="timezone1Tz" style="margin-bottom: 0.75rem;"></select>
                    </div>
                    <div class="timezone-config-item">
                        <label style="font-size: 0.75rem; color: var(--color2); margin-bottom: 0.25rem; display: block;">Timezone 2:</label>
                        <input type="text" id="timezone2Label" placeholder="Label" style="margin-bottom: 0.375rem;">
                        <select id="timezone2Tz" style="margin-bottom: 0.75rem;"></select>
                    </div>
                    <div class="timezone-config-item">
                        <label style="font-size: 0.75rem; color: var(--color2); margin-bottom: 0.25rem; display: block;">Timezone 3:</label>
                        <input type="text" id="timezone3Label" placeholder="Label" style="margin-bottom: 0.375rem;">
                        <select id="timezone3Tz" style="margin-bottom: 0.75rem;"></select>
                    </div>
                    <div class="timezone-config-item">
                        <label style="font-size: 0.75rem; color: var(--color2); margin-bottom: 0.25rem; display: block;">Timezone 4:</label>
                        <input type="text" id="timezone4Label" placeholder="Label" style="margin-bottom: 0.375rem;">
                        <select id="timezone4Tz" style="margin-bottom: 0.75rem;"></select>
                    </div>
                    <button class="primary-btn" onclick="saveTimezoneConfig()">Save</button>
                </div>
            </div>
        </div>

        <!-- Tactics Config Modal -->
        <div id="tacticsConfigModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="hideTacticsConfig()">&times;</span>
                <h2>Configure Tactics</h2>
                <div class="link-input-group">
                    <input type="text" id="tacticInput" placeholder="Enter a tactic...">
                    <button class="primary-btn" onclick="addTactic()">Add</button>
                </div>
                <div class="links-list" id="tacticsList"></div>
            </div>
        </div>

        <!-- Data Management Modal -->
        <div id="dataManagementModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="hideDataManagement()">&times;</span>
                <h2>Data Management</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
                    <div>
                        <h3 style="font-size: 0.875rem; color: var(--color4); margin-bottom: 0.5rem;">Export Data</h3>
                        <p style="font-size: 0.75rem; color: var(--color2); margin-bottom: 0.75rem;">
                            Download all your data as a JSON backup file.
                        </p>
                        <button class="primary-btn" onclick="exportLocalStorage()">
                            <i class="fa-solid fa-download"></i> Export Data
                        </button>
                    </div>
                    <div style="border-top: 1px solid var(--color2); padding-top: 1rem;">
                        <h3 style="font-size: 0.875rem; color: var(--color4); margin-bottom: 0.5rem;">Import Data</h3>
                        <p style="font-size: 0.75rem; color: var(--color2); margin-bottom: 0.75rem;">
                            Restore data from a previously exported backup file.
                        </p>
                        <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importLocalStorage(event)">
                        <button class="primary-btn" onclick="document.getElementById('importFileInput').click()">
                            <i class="fa-solid fa-upload"></i> Import Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script>
        // Initialize CodeMirror editor
        const editor = CodeMirror(document.getElementById('editor-container'), {
            value: localStorage.getItem('notes') || '',
            mode: 'text/plain',
            theme: 'dracula',
            lineNumbers: true,
            lineWrapping: true,
            autofocus: false,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false
        });
        
        // Auto-save notes on change
        editor.on('change', function() {
            localStorage.setItem('notes', editor.getValue());
        });
        
        // Copy notes function - copies plain text (zero formatting)
        function copyNotes() {
            try {
                const text = editor.getValue();
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(() => {
                        // Visual feedback - briefly change icon
                        const copyIcon = document.querySelector('.notes-section .fa-copy');
                        if (copyIcon) {
                            const originalClass = copyIcon.className;
                            copyIcon.className = 'fa-solid fa-check';
                            setTimeout(() => {
                                copyIcon.className = originalClass;
                            }, 1000);
                        }
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        // Fallback to older method
                        fallbackCopyTextToClipboard(text);
                    });
                } else {
                    // Fallback for older browsers
                    fallbackCopyTextToClipboard(text);
                }
            } catch (error) {
                console.error('Error copying notes:', error);
            }
        }
        
        // Fallback copy method for older browsers
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                // Visual feedback
                const copyIcon = document.querySelector('.notes-section .fa-copy');
                if (copyIcon) {
                    const originalClass = copyIcon.className;
                    copyIcon.className = 'fa-solid fa-check';
                    setTimeout(() => {
                        copyIcon.className = originalClass;
                    }, 1000);
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
            }
            document.body.removeChild(textArea);
        }
        
        // Make copyNotes globally accessible
        window.copyNotes = copyNotes;
        
        // Task Picker functionality
        // Clear old data and start fresh (only once)
        const taskMigrationDone = localStorage.getItem('taskMigrationDone');
        if (!taskMigrationDone) {
            localStorage.removeItem('tasks');
            localStorage.removeItem('taskStats');
            localStorage.setItem('taskMigrationDone', 'true');
        }
        
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        
        // Emotional Tracker variables - declare early to avoid temporal dead zone
        let selectedEmotions = [];
        let emotionLogs = JSON.parse(localStorage.getItem('emotionLogs')) || [];
        
        function saveTasksToStorage() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }
        
        let currentTask = null;
        let currentTaskColor = null;
        let selectedTaskDuration = 15; // Default duration
        
        // Task statistics tracking - start fresh, but load existing stats if any
        let taskStats = JSON.parse(localStorage.getItem('taskStats')) || {};
        
        // Helper function to select task duration
        function selectTaskDuration(duration) {
            selectedTaskDuration = duration;
            
            // Update button states
            document.querySelectorAll('.task-duration-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            if (duration === 'custom') {
                document.querySelector('.task-duration-btn.custom').classList.add('selected');
                document.getElementById('taskDurationCustom').style.display = 'block';
                document.getElementById('taskDurationCustom').focus();
            } else {
                document.querySelector(`[data-duration="${duration}"]`).classList.add('selected');
                document.getElementById('taskDurationCustom').style.display = 'none';
                document.getElementById('taskDurationCustom').value = '';
            }
        }
        
        // Initialize default duration selection
        setTimeout(() => {
            if (document.querySelector('[data-duration="15"]')) {
                selectTaskDuration(15);
            }
        }, 100);
        
        // Helper function to generate task ID: {counter}{3 random letters}
        function generateTaskId() {
            // Get the highest counter from existing tasks
            let maxCounter = 0;
            tasks.forEach(task => {
                if (task && task.id) {
                    const counter = parseInt(task.id.match(/^\d+/)?.[0] || '0');
                    if (counter > maxCounter) {
                        maxCounter = counter;
                    }
                }
            });
            
            const counter = maxCounter + 1;
            const randomLetters = String.fromCharCode(
                97 + Math.floor(Math.random() * 26),
                97 + Math.floor(Math.random() * 26),
                97 + Math.floor(Math.random() * 26)
            );
            
            return `${counter}${randomLetters}`;
        }
        
        // Helper function to parse comma-separated tags string
        function parseTags(tagString) {
            if (!tagString) return [];
            return tagString.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
        }
        
        // Helper function to format tags array to comma-separated string
        function formatTags(tagsArray) {
            if (!tagsArray || tagsArray.length === 0) return '';
            return tagsArray.join(', ');
        }
        
        function logTaskEvent(taskId, eventType) {
            if (!taskId) return;
            
            // Initialize task stats if it doesn't exist
            if (!taskStats[taskId]) {
                taskStats[taskId] = {
                    presented: 0,
                    accepted: 0,
                    completed: 0,
                    cancelled: 0,
                    history: []
                };
            }
            
            // Increment the counter for this event type
            taskStats[taskId][eventType]++;
            
            // Add to history with timestamp
            taskStats[taskId].history.push({
                event: eventType,
                timestamp: new Date().toISOString()
            });
            
            // Save to localStorage
            localStorage.setItem('taskStats', JSON.stringify(taskStats));
        }
        
        function pickRandomTask() {
            if (tasks.length === 0) {
                const display = document.getElementById('taskDisplay');
                display.innerHTML = '<span class="empty helper-text">No tasks available. Add some first!</span><span class="task-spinner"></span>';
                display.classList.remove('has-task', 'loading');
                const acceptBtn = document.getElementById('acceptTaskBtn');
                if (acceptBtn) acceptBtn.disabled = true;
                return;
            }
            
            const display = document.getElementById('taskDisplay');
            const isTransitioning = currentTask !== null && display.classList.contains('has-task');
            const paletteColors = ['var(--color5)', 'var(--color6)', 'var(--color7)', 'var(--color8)', 'var(--color9)', 'var(--color10)', 'var(--color11)'];
            const randomColor = paletteColors[Math.floor(Math.random() * paletteColors.length)];
            
            // If transitioning between tasks, show spinner for 1 second
            if (isTransitioning) {
                display.classList.add('loading');
                display.innerHTML = '<span class="task-spinner"></span>';
                
                setTimeout(() => {
            const randomIndex = Math.floor(Math.random() * tasks.length);
            const selectedTask = tasks[randomIndex];
                    currentTask = selectedTask;
                    currentTaskColor = randomColor;
                    
                    // Log that this task was presented
                    logTaskEvent(selectedTask.id, 'presented');
                    
                    display.classList.remove('loading');
                    display.innerHTML = `<span style="color:${currentTaskColor};">${selectedTask.name}</span><span class="task-spinner"></span>`;
                    display.classList.add('has-task');
                    const acceptBtn = document.getElementById('acceptTaskBtn');
                    if (acceptBtn) acceptBtn.disabled = false;
                    
                    // Add Enter key handler to accept task
                    function handleTaskAcceptKeyPressTransition(e) {
                        if (e.key === 'Enter' && currentTask && display.classList.contains('has-task')) {
                            document.removeEventListener('keydown', handleTaskAcceptKeyPressTransition);
                            acceptTask();
                        }
                    }
                    document.addEventListener('keydown', handleTaskAcceptKeyPressTransition);
                }, 1000);
            } else {
                // Initial pick - no spinner delay
                const randomIndex = Math.floor(Math.random() * tasks.length);
                const selectedTask = tasks[randomIndex];
                currentTask = selectedTask;
                currentTaskColor = randomColor;
                
                // Log that this task was presented
                logTaskEvent(selectedTask.id, 'presented');
                
                display.innerHTML = `<span style="color:${currentTaskColor};">${selectedTask.name}</span><span class="task-spinner"></span>`;
                display.classList.add('has-task');
                const acceptBtn = document.getElementById('acceptTaskBtn');
                if (acceptBtn) acceptBtn.disabled = false;
                
                // Add Enter key handler to accept task
                function handleTaskAcceptKeyPress(e) {
                    if (e.key === 'Enter' && currentTask && display.classList.contains('has-task')) {
                        document.removeEventListener('keydown', handleTaskAcceptKeyPress);
                        acceptTask();
                    }
                }
                document.addEventListener('keydown', handleTaskAcceptKeyPress);
            }
        }
        
        function acceptTask() {
            if (!currentTask) return;
            
            // Log that this task was accepted
            logTaskEvent(currentTask.id, 'accepted');
            
            // Highlight the timer section
            const timerSection = document.querySelector('.timer-section');
            timerSection.classList.add('highlighted');
            
            // Remove highlight after animation completes (6 seconds: 3 pulses  2s each)
            setTimeout(() => {
                timerSection.classList.remove('highlighted');
            }, 6000);
            
            // Find and highlight the matching timer button
            const taskDuration = currentTask.duration;
            let matchingTimerButton = null;
            
            // Check if duration matches a preset (5, 15, 30, 45, 60)
            if ([5, 15, 30, 45, 60].includes(taskDuration)) {
                matchingTimerButton = document.querySelector(`.timer-preset[data-minutes="${taskDuration}"]`);
            } else {
                // For custom durations, highlight the custom timer button
                matchingTimerButton = document.querySelector('.timer-preset.custom-timer-btn');
            }
            
            // Remove any existing highlights
            document.querySelectorAll('.timer-preset').forEach(btn => {
                btn.classList.remove('task-highlighted');
            });
            
            // Highlight the matching button
            if (matchingTimerButton) {
                matchingTimerButton.classList.add('task-highlighted');
            }
            
            // Show accepted task with completion options
            const display = document.getElementById('taskDisplay');
            display.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px; width: 100%;">
                    <div style="font-size: 12px; color: var(--color2); text-transform: uppercase;">Current Task:</div>
                    <div style="font-size: 14px; color: ${currentTaskColor || 'var(--color4)'};">${currentTask.name}</div>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                        <a href="#" id="taskDoneLink" style="color: var(--color6); text-decoration: none; font-size: 13px;">Task Done</a>
                        <span style="color: var(--color2);">|</span>
                        <a href="#" id="taskCancelledLink" style="color: var(--color10); text-decoration: none; font-size: 13px;">Task Cancelled</a>
                    </div>
                </div>
                <span class="task-spinner"></span>
            `;
            display.classList.add('has-task');
            display.classList.remove('loading');
            const acceptBtn = document.getElementById('acceptTaskBtn');
            if (acceptBtn) acceptBtn.disabled = true;
            
            // Add Enter key handler to start the highlighted timer
            function handleTaskTimerKeyPress(e) {
                if (e.key === 'Enter' && matchingTimerButton && !matchingTimerButton.classList.contains('inactive')) {
                    // Remove highlight class
                    matchingTimerButton.classList.remove('task-highlighted');
                    
                    // Start the timer
                    if ([5, 15, 30, 45, 60].includes(taskDuration)) {
                        startTimerProgrammatically(taskDuration, matchingTimerButton);
                    } else {
                        // For custom duration, set the custom duration span and start timer
                        matchingTimerButton = document.querySelector('.timer-preset.custom-timer-btn');
                        if (matchingTimerButton) {
                            const durationSpan = matchingTimerButton.querySelector('.timer-duration');
                            if (durationSpan) {
                                durationSpan.textContent = taskDuration.toString();
                            }
                            // Simulate click on custom button
                            matchingTimerButton.click();
                        }
                    }
                    
                    // Remove the key listener after starting timer
                    document.removeEventListener('keydown', handleTaskTimerKeyPress);
                }
            }
            
            // Add the key listener
            document.addEventListener('keydown', handleTaskTimerKeyPress);
            
            // Also remove listener when task is done or cancelled
            const cleanupTimerHighlight = function() {
                document.removeEventListener('keydown', handleTaskTimerKeyPress);
                if (matchingTimerButton) {
                    matchingTimerButton.classList.remove('task-highlighted');
                }
            };
            
            // Add event listeners to the links with cleanup
            document.getElementById('taskDoneLink').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();  // Prevent click from bubbling to taskDisplay
                cleanupTimerHighlight();
                taskDone();
            });
            document.getElementById('taskCancelledLink').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();  // Prevent click from bubbling to taskDisplay
                cleanupTimerHighlight();
                taskCancelled();
            });
        }
        
        function taskDone() {
            // Log that this task was completed
            logTaskEvent(currentTask.id, 'completed');
            
            // Clear the task display
            const display = document.getElementById('taskDisplay');
            display.innerHTML = '<span class="empty helper-text">Click to pick a task</span><span class="task-spinner"></span>';
            display.classList.remove('has-task', 'loading');
            currentTask = null;
            currentTaskColor = null;
            
            // Disable the accept button
            const acceptBtn = document.getElementById('acceptTaskBtn');
            if (acceptBtn) acceptBtn.disabled = true;
        }
        
        function taskCancelled() {
            // Log that this task was cancelled
            logTaskEvent(currentTask.id, 'cancelled');
            
            // Reset the timer if it's running
            if (isRunning || isPaused) {
                clearInterval(timerInterval);
                stopBeeping(); // Stop beeping when task is cancelled
                isRunning = false;
                isPaused = false;
                
                if (activeTimerButton) {
                    activeTimerButton.classList.remove('active', 'paused', 'task-highlighted');
                    activeTimerButton = null;
                }
                
                timeRemaining = 0;
                initialTime = 0;
                window.currentTimerMinutes = null;
                
                // Reset custom timer display if it was the custom button
                const customBtn = document.querySelector('.timer-preset.custom-timer-btn');
                if (customBtn) {
                    const durationSpan = customBtn.querySelector('.timer-duration');
                    if (durationSpan) {
                        durationSpan.textContent = 'XX';
                    }
                }
                
                updateTimerButtons();
            }
            
            // Clear the task display
            const display = document.getElementById('taskDisplay');
            display.innerHTML = '<span class="empty helper-text">Click to pick a task</span><span class="task-spinner"></span>';
            display.classList.remove('has-task', 'loading');
            currentTask = null;
            currentTaskColor = null;
            
            // Disable the accept button
            const acceptBtn = document.getElementById('acceptTaskBtn');
            if (acceptBtn) acceptBtn.disabled = true;
        }
        
        function addTask() {
            const taskInput = document.getElementById('taskInput');
            const taskTagsInput = document.getElementById('taskTags');
            const taskDurationCustomInput = document.getElementById('taskDurationCustom');
            
            const taskName = taskInput.value.trim();
            let taskDuration;
            
            if (selectedTaskDuration === 'custom') {
                taskDuration = parseInt(taskDurationCustomInput.value) || 15;
            } else {
                taskDuration = selectedTaskDuration;
            }
            
            const taskTags = taskTagsInput.value.trim() || '';
            
            if (taskName) {
                const newTask = {
                    id: generateTaskId(),
                    name: taskName,
                    duration: taskDuration,
                    tags: taskTags
                };
                
                tasks.push(newTask);
                saveTasksToStorage();
                
                // Clear all input fields
                taskInput.value = '';
                taskTagsInput.value = '';
                taskDurationCustomInput.value = '';
                selectTaskDuration(15); // Reset to default
                
                renderTasksInModal();
            }
        }
        
        function deleteTask(taskId) {
            const index = tasks.findIndex(task => task.id === taskId);
            if (index > -1) {
            tasks.splice(index, 1);
            saveTasksToStorage();
                renderTasksInModal();
            }
        }
        
        // Quick Links functionality
        let links = JSON.parse(localStorage.getItem('links')) || [];
        
        function renderLinks() {
            const container = document.getElementById('linksContainer');
            container.innerHTML = '';
            
            // Always render 16 buttons (4x4 grid)
            for (let i = 0; i < 16; i++) {
                const linkEl = document.createElement('a');
                
                if (i < links.length && links[i].url) {
                    // Link exists - render it normally
                    linkEl.className = 'link-item';
                    linkEl.href = links[i].url;
                    linkEl.target = '_blank';
                    linkEl.textContent = links[i].name;
                } else {
                    // Empty slot - render with gray styling
                    linkEl.className = 'link-item empty';
                    linkEl.href = '#';
                    linkEl.textContent = 'Empty';
                    linkEl.onclick = function(e) {
                        e.preventDefault();
                        return false;
                    };
                }
                
                container.appendChild(linkEl);
            }
        }
        
        function addLink() {
            const name = document.getElementById('linkName').value.trim();
            const url = document.getElementById('linkUrl').value.trim();
            
            if (name && url) {
                links.push({ name, url });
                localStorage.setItem('links', JSON.stringify(links));
                document.getElementById('linkName').value = '';
                document.getElementById('linkUrl').value = '';
                renderLinks();
                renderLinksInModal();
            }
        }
        
        function deleteLink(index) {
            links.splice(index, 1);
            localStorage.setItem('links', JSON.stringify(links));
            renderLinks();
            renderLinksInModal();
        }
        
        // Initialize links
        renderLinks();
        
        // Task display click handler - pick task if empty, or pick another if task is displayed
        document.getElementById('taskDisplay').addEventListener('click', function() {
            // Don't do anything if task is accepted (has-task class but showing "Current Task")
            if (this.querySelector('#taskDoneLink') || this.querySelector('#taskCancelledLink')) {
                return;
            }
            
            // If no task is displayed, pick a random one
            if (!currentTask && !this.classList.contains('has-task')) {
                pickRandomTask();
            } 
            // If a task is displayed but not accepted, pick another one
            else if (currentTask && this.classList.contains('has-task')) {
                pickRandomTask();
            }
        });
        
        // Projects functionality
        let projects = JSON.parse(localStorage.getItem('projects')) || [];
        
        function renderProjects() {
            const container = document.getElementById('projectsContainer');
            container.innerHTML = '';
            
            // Always render 16 buttons (4x4 grid)
            for (let i = 0; i < 16; i++) {
                const projectEl = document.createElement('a');
                
                if (i < projects.length && projects[i].url) {
                    // Project exists - render it normally
                    projectEl.className = 'link-item';
                    projectEl.href = projects[i].url;
                    projectEl.target = '_blank';
                    projectEl.textContent = projects[i].name;
                } else {
                    // Empty slot - render with gray styling
                    projectEl.className = 'link-item empty';
                    projectEl.href = '#';
                    projectEl.textContent = 'Empty';
                    projectEl.onclick = function(e) {
                        e.preventDefault();
                        return false;
                    };
                }
                
                container.appendChild(projectEl);
            }
        }
        
        function addProject() {
            const name = document.getElementById('projectName').value.trim();
            const url = document.getElementById('projectUrl').value.trim();
            
            if (name && url) {
                projects.push({ name, url });
                localStorage.setItem('projects', JSON.stringify(projects));
                document.getElementById('projectName').value = '';
                document.getElementById('projectUrl').value = '';
                renderProjects();
                renderProjectsInModal();
            }
        }
        
        function deleteProject(index) {
            projects.splice(index, 1);
            localStorage.setItem('projects', JSON.stringify(projects));
            renderProjects();
            renderProjectsInModal();
        }
        
        // Initialize projects
        renderProjects();
        
        // Timer functionality
        let timerInterval;
        let beepInterval;
        let timeRemaining = 0;
        let initialTime = 0;
        let isRunning = false;
        let isPaused = false;
        let activeTimerButton = null;
        
        // Mute functionality - declare early so beep functions can access it
        let isMuted = localStorage.getItem('timerMuted') === 'true';
        
        // Beep sound functionality
        let audioContext = null;
        
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            // Resume audio context if suspended (browsers require user interaction)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }
        
        function playBeep() {
            if (isMuted) return;
            
            try {
                initAudioContext();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800; // Beep frequency in Hz
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                // Silently fail if audio context can't be created
                console.log('Audio context not available');
            }
        }
        
        function startBeeping() {
            if (isMuted) return;
            stopBeeping(); // Clear any existing beep interval
            // Only start beeping if we're in the last 3 seconds
            if (timeRemaining <= 3) {
                playBeep(); // Play immediately
                beepInterval = setInterval(() => {
                    if (timeRemaining <= 3 && !isMuted) {
                        playBeep();
                    } else {
                        stopBeeping();
                    }
                }, 1000); // Play beep every second
            }
        }
        
        function stopBeeping() {
            if (beepInterval) {
                clearInterval(beepInterval);
                beepInterval = null;
            }
        }
        
        function playCompletionBeep() {
            if (isMuted) return;
            
            stopBeeping(); // Stop any running beeps first
            
            // Play 3 beeps in sequence
            playBeep();
            setTimeout(() => {
                if (!isMuted) playBeep();
            }, 300);
            setTimeout(() => {
                if (!isMuted) playBeep();
            }, 600);
        }
        
        // Activity tracking
        const MAX_ACTIVITY_CELLS = 24;
        
        function loadActivityLog() {
            const stored = localStorage.getItem('timerActivityLog');
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveActivityLog(log) {
            localStorage.setItem('timerActivityLog', JSON.stringify(log));
        }
        
        function addTimerActivity(minutes) {
            const activityLog = loadActivityLog();
            
            // Determine class based on minutes
            let timerClass;
            if (minutes === 5) timerClass = 'timer-5';
            else if (minutes === 15) timerClass = 'timer-15';
            else if (minutes === 30) timerClass = 'timer-30';
            else if (minutes === 45) timerClass = 'timer-45';
            else if (minutes === 60) timerClass = 'timer-60';
            else timerClass = 'timer-custom';
            
            activityLog.push({
                minutes: minutes,
                class: timerClass,
                timestamp: new Date().toISOString()
            });
            
            // Keep only the last MAX_ACTIVITY_CELLS entries
            if (activityLog.length > MAX_ACTIVITY_CELLS) {
                activityLog.shift();
            }
            
            saveActivityLog(activityLog);
            renderActivityBars();
        }
        
        function renderActivityBars() {
            const container = document.getElementById('activityBars');
            container.innerHTML = '';
            
            const activityLog = loadActivityLog();
            
            // Create all 24 bars
            for (let i = 0; i < MAX_ACTIVITY_CELLS; i++) {
                const bar = document.createElement('div');
                bar.className = 'activity-bar';
                
                // If we have activity for this position
                if (activityLog[i]) {
                    bar.classList.add(activityLog[i].class);
                    bar.title = `${activityLog[i].minutes} minute timer`;
                } else {
                    bar.title = 'No timer';
                }
                
                container.appendChild(bar);
            }
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        function updateTimerButtons() {
            const buttons = document.querySelectorAll('.timer-preset');
            buttons.forEach(btn => {
                if (btn === activeTimerButton) {
                    btn.classList.remove('inactive');
                    if (isPaused) {
                        btn.classList.add('paused');
                    } else {
                        btn.classList.remove('paused');
                    }
                } else if (isRunning || isPaused) {
                    btn.classList.add('inactive');
                    btn.classList.remove('active', 'paused');
                } else {
                    btn.classList.remove('inactive', 'active', 'paused');
                }
            });
            
            // Update display on active button
            if (activeTimerButton) {
                if (activeTimerButton.classList.contains('custom-timer-btn')) {
                    // For custom timer, update the timer-duration field with countdown
                    const durationSpan = activeTimerButton.querySelector('.timer-duration');
                    if (durationSpan) {
                        durationSpan.textContent = formatTime(timeRemaining);
                    }
                    // Hide timer-display for custom timer
                    const displaySpan = activeTimerButton.querySelector('.timer-display');
                    if (displaySpan) {
                        displaySpan.style.display = 'none';
                    }
                } else {
                    // For regular timers, use timer-display
                    const displaySpan = activeTimerButton.querySelector('.timer-display');
                    if (displaySpan) {
                        displaySpan.textContent = formatTime(timeRemaining);
                    }
                }
            }
        }
        
        function startTimerProgrammatically(minutes, buttonElement) {
            // If another timer is running, ignore
            if (isRunning || isPaused) {
                return;
            }
            
            // Start new timer
            activeTimerButton = buttonElement;
            timeRemaining = minutes * 60;
            initialTime = minutes * 60;
            window.currentTimerMinutes = minutes;
                isRunning = true;
            isPaused = false;
            
            activeTimerButton.classList.add('active');
            updateTimerButtons();
            
            // Don't start beeping immediately - will start in last 3 seconds
            
                timerInterval = setInterval(() => {
                    if (timeRemaining > 0) {
                        timeRemaining--;
                    updateTimerButtons();
                    // Start beeping when we reach the last 3 seconds
                    if (timeRemaining <= 3 && !beepInterval) {
                        startBeeping();
                    }
                    } else {
                        clearInterval(timerInterval);
                    stopBeeping(); // Stop continuous beeping
                    playCompletionBeep(); // Play completion beep sequence
                        isRunning = false;
                    isPaused = false;
                    activeTimerButton.classList.remove('active');
                    activeTimerButton = null;
                    
                    // Add timer to activity log when it completes
                    if (window.currentTimerMinutes) {
                        addTimerActivity(window.currentTimerMinutes);
                    }
                    
                    updateTimerButtons();
                    
                    if (!isMuted) {
                        if (Notification.permission === "granted") {
                            new Notification("Timer Complete", { body: "Time is up!" });
                        } else {
                            alert('Time is up!');
                        }
                        }
                    }
                }, 1000);
            }
        
        function handleTimerClick(minutes, buttonElement) {
            const clickedButton = buttonElement || event?.currentTarget || document.querySelector(`[data-minutes="${minutes}"]`);
            
            if (!clickedButton) {
                console.error('Could not find timer button');
                return;
            }
            
            // If clicking the active button
            if (activeTimerButton === clickedButton) {
                if (isRunning) {
                    // Pause the timer
            clearInterval(timerInterval);
                    stopBeeping(); // Stop beeping when paused
            isRunning = false;
                    isPaused = true;
                    updateTimerButtons();
                } else if (isPaused) {
                    // Reset the timer
                    clearInterval(timerInterval);
                    stopBeeping(); // Stop beeping when reset
                    isRunning = false;
                    isPaused = false;
                    activeTimerButton.classList.remove('active', 'paused');
                    activeTimerButton = null;
                    timeRemaining = 0;
                    initialTime = 0;
                    updateTimerButtons();
                }
                return;
            }
            
            // If another timer is running, ignore
            if (isRunning || isPaused) {
                return;
            }
            
            // Start new timer
            activeTimerButton = clickedButton;
            timeRemaining = minutes * 60;
            initialTime = minutes * 60;
            window.currentTimerMinutes = minutes;
            isRunning = true;
            isPaused = false;
            
            activeTimerButton.classList.add('active');
            updateTimerButtons();
            
            // Don't start beeping immediately - will start in last 3 seconds
            
            timerInterval = setInterval(() => {
                if (timeRemaining > 0) {
                    timeRemaining--;
                    updateTimerButtons();
                    // Start beeping when we reach the last 3 seconds
                    if (timeRemaining <= 3 && !beepInterval) {
                        startBeeping();
                    }
                } else {
            clearInterval(timerInterval);
                    stopBeeping(); // Stop continuous beeping
                    playCompletionBeep(); // Play completion beep sequence
            isRunning = false;
                    isPaused = false;
                    activeTimerButton.classList.remove('active');
                    activeTimerButton = null;
                    
                    // Add timer to activity log when it completes
                    if (window.currentTimerMinutes) {
                        addTimerActivity(window.currentTimerMinutes);
                    }
                    
                    updateTimerButtons();
                    
                    if (!isMuted) {
                        if (Notification.permission === "granted") {
                            new Notification("Timer Complete", { body: "Time is up!" });
                        } else {
                            alert('Time is up!');
                        }
                    }
                }
            }, 1000);
        }
        
        function handleCustomTimerClick() {
            const clickedButton = event?.currentTarget || document.querySelector('.timer-preset.custom-timer-btn');
            
            if (!clickedButton) {
                console.error('Could not find custom timer button');
                return;
            }
            
            // Don't start timer if clicking on the editable duration span
            if (event?.target?.classList.contains('timer-duration')) {
                return;
            }
            
            // If clicking the active button
            if (activeTimerButton === clickedButton) {
                if (isRunning) {
                    // Pause the timer
                    clearInterval(timerInterval);
                    stopBeeping(); // Stop beeping when paused
                    isRunning = false;
                    isPaused = true;
                    updateTimerButtons();
                } else if (isPaused) {
                    // Reset the timer (clear everything)
                    clearInterval(timerInterval);
                    stopBeeping(); // Stop beeping when reset
                    isRunning = false;
                    isPaused = false;
                    activeTimerButton.classList.remove('active', 'paused');
                    activeTimerButton = null;
                    timeRemaining = 0;
                    initialTime = 0;
                    // Reset the duration display and make it editable again
                    const durationSpan = clickedButton.querySelector('.timer-duration');
                    if (durationSpan) {
                        durationSpan.textContent = 'XX';
                        durationSpan.contentEditable = 'true';
                    }
                    updateTimerButtons();
                }
                return;
            }
            
            // If another timer is running, ignore
            if (isRunning || isPaused) {
                return;
            }
            
            // Get value from editable duration span
            const durationSpan = clickedButton.querySelector('.timer-duration');
            const minutes = parseInt(durationSpan?.textContent || '0');
            
            if (!minutes || minutes <= 0) {
                // If no valid value, focus the editable span so user can type
                if (durationSpan) {
                    durationSpan.focus();
                }
                return;
            }
            
            // Start new timer with the value
            activeTimerButton = clickedButton;
            timeRemaining = minutes * 60;
            initialTime = minutes * 60;
            window.currentTimerMinutes = minutes;
            isRunning = true;
            isPaused = false;
            
            // Make the duration non-editable when timer is active
            if (durationSpan) {
                durationSpan.contentEditable = 'false';
            }
            
            activeTimerButton.classList.add('active');
            updateTimerButtons();
            
            // Don't start beeping immediately - will start in last 3 seconds
            
            timerInterval = setInterval(() => {
                if (timeRemaining > 0) {
                    timeRemaining--;
                    updateTimerButtons();
                    // Start beeping when we reach the last 3 seconds
                    if (timeRemaining <= 3 && !beepInterval) {
                        startBeeping();
                    }
                } else {
                    clearInterval(timerInterval);
                    stopBeeping(); // Stop continuous beeping
                    playCompletionBeep(); // Play completion beep sequence
                    isRunning = false;
                    isPaused = false;
                    activeTimerButton.classList.remove('active');
                    const wasCustomTimer = activeTimerButton.classList.contains('custom-timer-btn');
                    activeTimerButton = null;
                    
                    // Reset custom timer display if it was the custom button
                    if (wasCustomTimer) {
                        const customBtn = document.querySelector('.timer-preset.custom-timer-btn');
                        if (customBtn) {
                            const durationSpan = customBtn.querySelector('.timer-duration');
                            if (durationSpan) {
                                durationSpan.textContent = 'XX';
                                durationSpan.contentEditable = 'true';
                            }
                        }
                    }
                    
                    // Add timer to activity log when it completes
                    if (window.currentTimerMinutes) {
                        addTimerActivity(window.currentTimerMinutes);
                    }
                    
                    updateTimerButtons();
                    
                    if (!isMuted) {
                        if (Notification.permission === "granted") {
                            new Notification("Timer Complete", { body: "Time is up!" });
                        } else {
                            alert('Time is up!');
                        }
                    }
                }
            }, 1000);
        }
        
        // Initialize activity bars
        renderActivityBars();
        
        // Allow Enter key for inputs
        document.getElementById('linkUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addLink();
            }
        });
        
        document.getElementById('taskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTask();
            }
        });
        
        // Note: taskDuration element doesn't exist in current HTML, so this listener is removed
        // If taskDuration input is added back, uncomment this:
        // const taskDurationEl = document.getElementById('taskDuration');
        // if (taskDurationEl) {
        //     taskDurationEl.addEventListener('keypress', function(e) {
        //         if (e.key === 'Enter') {
        //             addTask();
        //         }
        //     });
        // }
        
        const taskTagsEl = document.getElementById('taskTags');
        if (taskTagsEl) {
            taskTagsEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTask();
                }
            });
        }
        
        const taskDurationCustomEl = document.getElementById('taskDurationCustom');
        if (taskDurationCustomEl) {
            taskDurationCustomEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTask();
                }
            });
        }
        
        // Add Enter key handler for custom timer duration
        const customDurationSpan = document.querySelector('.custom-timer-btn .timer-duration');
        if (customDurationSpan) {
            customDurationSpan.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    handleCustomTimerClick();
                }
            });
            
            // Only allow numbers
            customDurationSpan.addEventListener('input', function(e) {
                this.textContent = this.textContent.replace(/[^0-9]/g, '');
            });
        }
        
        // Request notification permission for timer
        if (Notification.permission === "default") {
            Notification.requestPermission();
        }
        
        // Mute functionality functions (isMuted variable declared earlier with timer variables)
        function toggleMute() {
            isMuted = !isMuted;
            localStorage.setItem('timerMuted', isMuted);
            updateMuteButton();
            
            // If timer is running, stop or start beeping based on mute state
            if (isRunning && !isMuted) {
                startBeeping();
            } else if (isMuted) {
                stopBeeping();
            }
        }
        
        function updateMuteButton() {
            const muteButton = document.getElementById('muteToggle');
            if (!muteButton) return; // Safety check
            
            if (isMuted) {
                muteButton.innerHTML = '<i class="fa-solid fa-bell-slash" aria-hidden="true"></i>';
                muteButton.classList.add('muted');
                muteButton.setAttribute('aria-label', 'Unmute timer');
                muteButton.setAttribute('title', 'Unmute timer');
            } else {
                muteButton.innerHTML = '<i class="fa-solid fa-bell" aria-hidden="true"></i>';
                muteButton.classList.remove('muted');
                muteButton.setAttribute('aria-label', 'Mute timer');
                muteButton.setAttribute('title', 'Mute timer');
            }
        }
        
        // Initialize mute button state after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateMuteButton);
        } else {
            updateMuteButton();
        }

        // Emotional Tracker functionality
        // Variables declared earlier to avoid temporal dead zone issues
        
        function toggleEmotion(emotion) {
            try {
                const button = document.querySelector(`[data-emotion="${emotion}"]`);
                if (!button) {
                    console.error('Emotion button not found:', emotion);
                    return;
                }
                
                const index = selectedEmotions.indexOf(emotion);
                
                if (index > -1) {
                    // Deselect emotion
                    selectedEmotions.splice(index, 1);
                    button.classList.remove('selected');
                } else {
                    // Select emotion (max 2)
                    if (selectedEmotions.length >= 2) {
                        return; // Can't select more than 2
                    }
                    selectedEmotions.push(emotion);
                    button.classList.add('selected');
                }
                
                updateEmotionButtons();
            } catch (error) {
                console.error('Error in toggleEmotion:', error);
            }
        }
        
        function updateEmotionButtons() {
            try {
                const buttons = document.querySelectorAll('.emotion-btn');
                if (buttons.length === 0) {
                    // DOM not ready yet, will be called again
                    return;
                }
                
                buttons.forEach(btn => {
                    if (selectedEmotions.length >= 2 && !btn.classList.contains('selected')) {
                        btn.classList.add('disabled');
                    } else {
                        btn.classList.remove('disabled');
                    }
                });
                
                // Update Log button disabled state
                const logBtn = document.getElementById('logEmotionBtn');
                if (logBtn) {
                    logBtn.disabled = selectedEmotions.length === 0;
                }
            } catch (error) {
                console.error('Error in updateEmotionButtons:', error);
            }
        }
        
        function logEmotion() {
            try {
                const textInput = document.getElementById('emotionInput');
                if (!textInput) {
                    console.error('Emotion input not found');
                    return;
                }
                
                const text = textInput.value.trim();
                
                if (selectedEmotions.length === 0) {
                    alert('Please select at least one emotion');
                    return;
                }
                
                // Create log entry
                const logEntry = {
                    emotions: [...selectedEmotions],
                    text: text,
                    timestamp: new Date().toISOString()
                };
                
                // Add to logs
                emotionLogs.push(logEntry);
                
                // Save to localStorage
                localStorage.setItem('emotionLogs', JSON.stringify(emotionLogs));
                
                // Reset form
                selectedEmotions = [];
                textInput.value = '';
                document.querySelectorAll('.emotion-btn').forEach(btn => {
                    btn.classList.remove('selected', 'disabled');
                });
                updateEmotionButtons(); // Update Log button state
                
                // Show confirmation (optional)
                const logBtn = document.querySelector('.emotion-section .primary-btn');
                if (logBtn) {
                    const originalText = logBtn.textContent;
                    logBtn.textContent = 'Logged!';
                    setTimeout(() => {
                        logBtn.textContent = originalText;
                    }, 1000);
                }
            } catch (error) {
                console.error('Error in logEmotion:', error);
            }
        }
        
        // Initialize emotion buttons state after DOM is ready
        function initEmotionTracker() {
            updateEmotionButtons();
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initEmotionTracker);
        } else {
            initEmotionTracker();
        }
        
        // Make functions globally accessible (for onclick handlers)
        window.toggleEmotion = toggleEmotion;
        window.logEmotion = logEmotion;
        window.updateEmotionButtons = updateEmotionButtons;

function showTaskConfig() {
    renderTasksInModal();
    document.getElementById('taskConfigModal').style.display = 'block';
}

function hideTaskConfig() {
    document.getElementById('taskConfigModal').style.display = 'none';
}

function showLinkConfig() {
    renderLinksInModal();
    document.getElementById('linkConfigModal').style.display = 'block';
}

function hideLinkConfig() {
    document.getElementById('linkConfigModal').style.display = 'none';
}

function renderTasksInModal() {
    const taskList = document.getElementById('taskList');
    taskList.innerHTML = '';
    
    tasks.forEach((task) => {
        const taskDiv = document.createElement('div');
        taskDiv.className = 'task-item';
        taskDiv.innerHTML = `
            <div style="flex: 1; display: flex; flex-direction: column; gap: 0.25rem;">
                <span style="font-weight: 600;">${task.name}</span>
                <div style="display: flex; gap: 0.5rem; font-size: 0.6875rem; color: var(--color2);">
                    <span>Duration: ${task.duration} min</span>
                    ${task.tags ? `<span>Tags: ${task.tags}</span>` : ''}
                </div>
            </div>
            <button class="danger icon-button" onclick="deleteTask('${task.id}')" aria-label="Delete task">
                <i class="fa-solid fa-trash"></i>
            </button>
        `;
        taskList.appendChild(taskDiv);
    });
}

function renderLinksInModal() {
    const linksList = document.getElementById('linksList');
    linksList.innerHTML = '';
    
    links.forEach((link, index) => {
        const linkDiv = document.createElement('div');
        linkDiv.className = 'link-item';
        linkDiv.innerHTML = `
            <a href="${link.url}" target="_blank">${link.name}</a>
            <button class="danger icon-button" onclick="deleteLink(${index})" aria-label="Delete link">
                <i class="fa-solid fa-trash"></i>
            </button>
        `;
        linksList.appendChild(linkDiv);
    });
}

function showProjectConfig() {
    renderProjectsInModal();
    document.getElementById('projectConfigModal').style.display = 'block';
}

function hideProjectConfig() {
    document.getElementById('projectConfigModal').style.display = 'none';
}

function renderProjectsInModal() {
    const projectsList = document.getElementById('projectsList');
    projectsList.innerHTML = '';
    
    projects.forEach((project, index) => {
        const projectDiv = document.createElement('div');
        projectDiv.className = 'link-item';
        projectDiv.innerHTML = `
            <a href="${project.url}" target="_blank">${project.name}</a>
            <button class="danger icon-button" onclick="deleteProject(${index})" aria-label="Delete project">
                <i class="fa-solid fa-trash"></i>
            </button>
        `;
        projectsList.appendChild(projectDiv);
    });
}

// Timezone functionality
let timezones = JSON.parse(localStorage.getItem('timezones')) || [];
let pinnedTimezoneIndex = parseInt(localStorage.getItem('pinnedTimezoneIndex')) || null;
let timezoneUpdateInterval = null;
let timezonePulseInterval = null;

// Common timezone abbreviations mapped to IANA timezones
const commonTimezones = [
    { label: 'EST/EDT (Eastern)', value: 'America/New_York' },
    { label: 'CST/CDT (Central)', value: 'America/Chicago' },
    { label: 'MST/MDT (Mountain)', value: 'America/Denver' },
    { label: 'PST/PDT (Pacific)', value: 'America/Los_Angeles' },
    { label: 'AKST/AKDT (Alaska)', value: 'America/Anchorage' },
    { label: 'HST (Hawaii)', value: 'America/Honolulu' },
    { label: 'GMT (Greenwich)', value: 'Europe/London' },
    { label: 'CET/CEST (Central Europe)', value: 'Europe/Paris' },
    { label: 'EET/EEST (Eastern Europe)', value: 'Europe/Athens' },
    { label: 'IST (India)', value: 'Asia/Kolkata' },
    { label: 'JST (Japan)', value: 'Asia/Tokyo' },
    { label: 'CST (China)', value: 'Asia/Shanghai' },
    { label: 'AEDT/AEST (Australia East)', value: 'Australia/Sydney' },
    { label: 'NZST/NZDT (New Zealand)', value: 'Pacific/Auckland' }
];

// IANA timezone list
const ianaTimezones = [
    'UTC',
    'America/New_York',
    'America/Chicago',
    'America/Denver',
    'America/Los_Angeles',
    'America/Phoenix',
    'America/Anchorage',
    'America/Honolulu',
    'America/Toronto',
    'America/Vancouver',
    'America/Mexico_City',
    'America/Sao_Paulo',
    'America/Buenos_Aires',
    'Europe/London',
    'Europe/Paris',
    'Europe/Berlin',
    'Europe/Rome',
    'Europe/Madrid',
    'Europe/Amsterdam',
    'Europe/Stockholm',
    'Europe/Vienna',
    'Europe/Zurich',
    'Europe/Athens',
    'Europe/Moscow',
    'Asia/Dubai',
    'Asia/Karachi',
    'Asia/Kolkata',
    'Asia/Bangkok',
    'Asia/Singapore',
    'Asia/Hong_Kong',
    'Asia/Shanghai',
    'Asia/Tokyo',
    'Asia/Seoul',
    'Asia/Jakarta',
    'Asia/Manila',
    'Australia/Sydney',
    'Australia/Melbourne',
    'Australia/Brisbane',
    'Australia/Perth',
    'Pacific/Auckland',
    'Pacific/Honolulu',
    'Africa/Cairo',
    'Africa/Johannesburg',
    'Africa/Lagos'
];

function populateTimezoneDropdowns() {
    for (let i = 1; i <= 4; i++) {
        const select = document.getElementById(`timezone${i}Tz`);
        if (!select) continue;
        
        select.innerHTML = '<option value="">Select timezone...</option>';
        
        // Add common timezone abbreviations first
        if (commonTimezones.length > 0) {
            const commonGroup = document.createElement('optgroup');
            commonGroup.label = 'Common Timezones';
            commonTimezones.forEach(tz => {
                const option = document.createElement('option');
                option.value = tz.value;
                option.textContent = tz.label;
                commonGroup.appendChild(option);
            });
            select.appendChild(commonGroup);
        }
        
        // Add separator option
        const separator = document.createElement('option');
        separator.disabled = true;
        separator.textContent = '';
        select.appendChild(separator);
        
        // Add IANA timezones
        ianaTimezones.forEach(tz => {
            const option = document.createElement('option');
            option.value = tz;
            option.textContent = tz;
            select.appendChild(option);
        });
    }
}

function renderTimezones() {
    const timezoneList = document.getElementById('timezoneList');
    timezoneList.innerHTML = '';
    
    if (timezones.length === 0) {
        timezoneList.innerHTML = '<div class="timezone-empty helper-text">No timezones configured. Click the gear icon to configure.</div>';
        return;
    }
    
    // Create a copy of timezones with their original indices for reordering
    let timezonesWithIndex = timezones.map((tz, idx) => ({ ...tz, originalIndex: idx }));
    
    // If a timezone is pinned, reorder based on time relative to pinned timezone
    if (pinnedTimezoneIndex !== null && pinnedTimezoneIndex < timezones.length) {
        const pinnedTz = timezones[pinnedTimezoneIndex];
        const now = new Date();
        
        // Get the current time in the pinned timezone
        const pinnedFormatter = new Intl.DateTimeFormat('en-US', {
            timeZone: pinnedTz.timezone,
            hour: 'numeric',
            minute: 'numeric',
            hour12: false
        });
        
        const pinnedParts = pinnedFormatter.formatToParts(now);
        let pinnedHour = 0, pinnedMin = 0;
        pinnedParts.forEach(p => {
            if (p.type === 'hour') pinnedHour = parseInt(p.value);
            if (p.type === 'minute') pinnedMin = parseInt(p.value);
        });
        const pinnedTimeMinutes = pinnedHour * 60 + pinnedMin;
        
        // Calculate time for each timezone and sort
        timezonesWithIndex.sort((a, b) => {
            const aFormatter = new Intl.DateTimeFormat('en-US', {
                timeZone: a.timezone,
                hour: 'numeric',
                minute: 'numeric',
                hour12: false
            });
            const bFormatter = new Intl.DateTimeFormat('en-US', {
                timeZone: b.timezone,
                hour: 'numeric',
                minute: 'numeric',
                hour12: false
            });
            
            const aParts = aFormatter.formatToParts(now);
            const bParts = bFormatter.formatToParts(now);
            let aHour = 0, aMin = 0, bHour = 0, bMin = 0;
            
            aParts.forEach(p => {
                if (p.type === 'hour') aHour = parseInt(p.value);
                if (p.type === 'minute') aMin = parseInt(p.value);
            });
            bParts.forEach(p => {
                if (p.type === 'hour') bHour = parseInt(p.value);
                if (p.type === 'minute') bMin = parseInt(p.value);
            });
            
            const aTimeMinutes = aHour * 60 + aMin;
            const bTimeMinutes = bHour * 60 + bMin;
            
            // Calculate offset from pinned time (handling day wrap-around)
            let aOffset = aTimeMinutes - pinnedTimeMinutes;
            let bOffset = bTimeMinutes - pinnedTimeMinutes;
            
            // Normalize offsets to -12 to +12 hours range
            if (aOffset > 720) aOffset -= 1440;
            if (aOffset < -720) aOffset += 1440;
            if (bOffset > 720) bOffset -= 1440;
            if (bOffset < -720) bOffset += 1440;
            
            return aOffset - bOffset;
        });
    }
    
    const table = document.createElement('table');
    table.className = 'timezone-table';
    
    timezonesWithIndex.forEach((tz, displayIndex) => {
        if (!tz.label || !tz.timezone) return;
        
        const row = document.createElement('tr');
        row.id = `timezone-row-${tz.originalIndex}`;
        
        const labelCell = document.createElement('td');
        labelCell.textContent = tz.label.trimEnd();
        
        const timeCell = document.createElement('td');
        timeCell.id = `timezone-time-${tz.originalIndex}`;
        timeCell.innerHTML = '';
        
        const pinCell = document.createElement('td');
        pinCell.className = 'timezone-pin-cell';
        const pinIcon = document.createElement('span');
        pinIcon.className = 'timezone-pin';
        if (tz.originalIndex === pinnedTimezoneIndex) {
            pinIcon.classList.add('pinned');
        }
        pinIcon.innerHTML = '<i class="fa-solid fa-thumbtack"></i>';
        pinIcon.onclick = (e) => {
            e.stopPropagation();
            togglePinTimezone(tz.originalIndex);
        };
        pinCell.appendChild(pinIcon);
        
        row.appendChild(labelCell);
        row.appendChild(timeCell);
        row.appendChild(pinCell);
        table.appendChild(row);
    });
    
    timezoneList.appendChild(table);
    
    updateTimezoneTimes();
}

function togglePinTimezone(index) {
    if (pinnedTimezoneIndex === index) {
        // Unpin if clicking the same pin
        pinnedTimezoneIndex = null;
    } else {
        pinnedTimezoneIndex = index;
    }
    localStorage.setItem('pinnedTimezoneIndex', pinnedTimezoneIndex !== null ? pinnedTimezoneIndex.toString() : '');
    renderTimezones();
}

function updateTimezoneTimes() {
    timezones.forEach((tz, index) => {
        if (!tz.label || !tz.timezone) return;
        
        try {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: tz.timezone,
                weekday: 'short',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            
            const parts = formatter.formatToParts(now);
            let day = '';
            let hour = '';
            let minute = '';
            
            parts.forEach(part => {
                if (part.type === 'weekday') day = part.value;
                if (part.type === 'hour') hour = part.value;
                if (part.type === 'minute') minute = part.value;
            });
            
            const timeElement = document.getElementById(`timezone-time-${index}`);
            if (timeElement) {
                const timeStr = `${day} ${hour}<span class="timezone-separator">:</span>${minute}`;
                
                // Calculate offset relative to pinned timezone or user's current timezone
                let referenceTz = null;
                if (pinnedTimezoneIndex !== null && pinnedTimezoneIndex < timezones.length) {
                    referenceTz = timezones[pinnedTimezoneIndex];
                }
                
                let offsetHours = 0;
                if (referenceTz) {
                    // Calculate offset relative to pinned timezone
                    const refFormatter = new Intl.DateTimeFormat('en-US', {
                        timeZone: referenceTz.timezone,
                        hour: 'numeric',
                        minute: 'numeric',
                        hour12: false
                    });
                    
                    const tzFormatter = new Intl.DateTimeFormat('en-US', {
                        timeZone: tz.timezone,
                        hour: 'numeric',
                        minute: 'numeric',
                        hour12: false
                    });
                    
                    const refParts = refFormatter.formatToParts(now);
                    const tzParts = tzFormatter.formatToParts(now);
                    let refHour = 0, refMin = 0, tzHour = 0, tzMin = 0;
                    
                    refParts.forEach(p => {
                        if (p.type === 'hour') refHour = parseInt(p.value);
                        if (p.type === 'minute') refMin = parseInt(p.value);
                    });
                    tzParts.forEach(p => {
                        if (p.type === 'hour') tzHour = parseInt(p.value);
                        if (p.type === 'minute') tzMin = parseInt(p.value);
                    });
                    
                    let offsetMinutes = (tzHour * 60 + tzMin) - (refHour * 60 + refMin);
                    offsetHours = Math.round(offsetMinutes / 60);
                    
                    // Normalize to -12 to +12 hours range
                    if (offsetHours > 12) offsetHours -= 24;
                    if (offsetHours < -12) offsetHours += 24;
                } else {
                    // Calculate offset relative to user's current timezone (original behavior)
                    const userTzFormatter = new Intl.DateTimeFormat('en-US', {
                        hour: 'numeric',
                        minute: 'numeric',
                        hour12: false
                    });
                    
                    const userParts = userTzFormatter.formatToParts(now);
                    let userHour = 0, userMin = 0;
                    userParts.forEach(p => {
                        if (p.type === 'hour') userHour = parseInt(p.value);
                        if (p.type === 'minute') userMin = parseInt(p.value);
                    });
                    
                    const tzFormatter = new Intl.DateTimeFormat('en-US', {
                        timeZone: tz.timezone,
                        hour: 'numeric',
                        minute: 'numeric',
                        hour12: false
                    });
                    
                    const tzParts = tzFormatter.formatToParts(now);
                    let tzHour = 0, tzMin = 0;
                    tzParts.forEach(p => {
                        if (p.type === 'hour') tzHour = parseInt(p.value);
                        if (p.type === 'minute') tzMin = parseInt(p.value);
                    });
                    
                    let offsetMinutes = (tzHour * 60 + tzMin) - (userHour * 60 + userMin);
                    offsetHours = Math.round(offsetMinutes / 60);
                    
                    // Normalize to -12 to +12 hours range
                    if (offsetHours > 12) offsetHours -= 24;
                    if (offsetHours < -12) offsetHours += 24;
                }
                
                const sign = offsetHours >= 0 ? '+' : '';
                const offsetStr = `<span class="timezone-offset">${sign}${offsetHours} hours</span>`;
                timeElement.innerHTML = `${timeStr} ${offsetStr}`;
            }
        } catch (error) {
            console.error(`Error updating timezone ${tz.timezone}:`, error);
            const timeElementError = document.getElementById(`timezone-time-${index}`);
            if (timeElementError) {
                timeElementError.textContent = 'Invalid timezone';
                timeElementError.style.color = 'var(--color10)';
            }
        }
    });
}

function showTimezoneConfig() {
    // Populate dropdowns if not already populated
    populateTimezoneDropdowns();
    
    // Load current timezones into form (remove trailing space from label for editing)
    for (let i = 1; i <= 4; i++) {
        const tz = timezones[i - 1] || { label: '', timezone: '' };
        const labelValue = tz.label ? tz.label.trimEnd() : '';
        document.getElementById(`timezone${i}Label`).value = labelValue;
        const select = document.getElementById(`timezone${i}Tz`);
        if (select) {
            select.value = tz.timezone || '';
        }
    }
    document.getElementById('timezoneConfigModal').style.display = 'block';
}

function hideTimezoneConfig() {
    document.getElementById('timezoneConfigModal').style.display = 'none';
}

function saveTimezoneConfig() {
    const newTimezones = [];
    
    for (let i = 1; i <= 4; i++) {
        const label = document.getElementById(`timezone${i}Label`).value.trim();
        const select = document.getElementById(`timezone${i}Tz`);
        const timezone = select ? select.value.trim() : '';
        
        if (label && timezone) {
            newTimezones.push({ label: label + ' ', timezone });
        }
    }
    
    timezones = newTimezones;
    localStorage.setItem('timezones', JSON.stringify(timezones));
    
    // Validate pinned index - reset if out of bounds
    if (pinnedTimezoneIndex !== null && pinnedTimezoneIndex >= timezones.length) {
        pinnedTimezoneIndex = null;
        localStorage.setItem('pinnedTimezoneIndex', '');
    }
    
    renderTimezones();
    hideTimezoneConfig();
}

// Initialize timezone display
renderTimezones();

// Set up update intervals
if (timezoneUpdateInterval) clearInterval(timezoneUpdateInterval);
timezoneUpdateInterval = setInterval(updateTimezoneTimes, 60000); // Update every minute

// Tactics functionality
let tactics = JSON.parse(localStorage.getItem('tactics')) || [];
let tacticsCheckInterval = null;
let lastTacticsMinute = null;

function renderTactics() {
    const tacticsDisplay = document.getElementById('tacticsDisplay');
    if (!tacticsDisplay) return;
    
    if (tactics.length === 0) {
        tacticsDisplay.innerHTML = '<span class="helper-text">No tactics configured. Click the gear icon to configure.</span>';
        return;
    }
    
    pickRandomTactic();
}

function pickRandomTactic() {
    const tacticsDisplay = document.getElementById('tacticsDisplay');
    if (!tacticsDisplay || tactics.length === 0) return;
    
    const randomIndex = Math.floor(Math.random() * tactics.length);
    const selectedTactic = tactics[randomIndex];
    tacticsDisplay.textContent = selectedTactic;
}

function checkAndUpdateTactics() {
    const now = new Date();
    const currentMinute = now.getMinutes();
    
    // Check if we're at :00 or :30
    if (currentMinute === 0 || currentMinute === 30) {
        // Only update if we haven't updated for this minute yet
        if (lastTacticsMinute !== currentMinute) {
            lastTacticsMinute = currentMinute;
            pickRandomTactic();
        }
    } else {
        // Reset the last minute tracker when not at :00 or :30
        lastTacticsMinute = null;
    }
}

function showTacticsConfig() {
    renderTacticsInModal();
    document.getElementById('tacticsConfigModal').style.display = 'block';
}

function hideTacticsConfig() {
    document.getElementById('tacticsConfigModal').style.display = 'none';
}

function renderTacticsInModal() {
    const tacticsList = document.getElementById('tacticsList');
    if (!tacticsList) return;
    tacticsList.innerHTML = '';
    
    tactics.forEach((tactic, index) => {
        const tacticDiv = document.createElement('div');
        tacticDiv.className = 'link-item';
        tacticDiv.innerHTML = `
            <span style="flex: 1; color: var(--color4); font-size: 0.875rem;">${tactic}</span>
            <button class="danger icon-button" onclick="deleteTactic(${index})" aria-label="Delete tactic">
                <i class="fa-solid fa-trash"></i>
            </button>
        `;
        tacticsList.appendChild(tacticDiv);
    });
}

function addTactic() {
    const tacticInput = document.getElementById('tacticInput');
    const tacticText = tacticInput.value.trim();
    
    if (tacticText) {
        tactics.push(tacticText);
        localStorage.setItem('tactics', JSON.stringify(tactics));
        tacticInput.value = '';
        renderTacticsInModal();
        renderTactics();
    }
}

function deleteTactic(index) {
    tactics.splice(index, 1);
    localStorage.setItem('tactics', JSON.stringify(tactics));
    renderTacticsInModal();
    renderTactics();
}

// Initialize tactics display
renderTactics();

// Set up interval to check for :00 and :30
if (tacticsCheckInterval) clearInterval(tacticsCheckInterval);
tacticsCheckInterval = setInterval(checkAndUpdateTactics, 1000); // Check every second

// Add Enter key support for tactics input
document.addEventListener('DOMContentLoaded', function() {
    const tacticInput = document.getElementById('tacticInput');
    if (tacticInput) {
        tacticInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTactic();
            }
        });
    }
});

// Panel blur toggle functionality
function togglePanelBlur(panelClass) {
    const panel = document.querySelector(`.${panelClass}`);
    if (panel) {
        panel.classList.toggle('blurred');
    }
}

// Data Management functions
function showDataManagement() {
    document.getElementById('dataManagementModal').style.display = 'block';
}

function hideDataManagement() {
    document.getElementById('dataManagementModal').style.display = 'none';
}

function exportLocalStorage() {
    try {
        // Collect all localStorage data
        const allData = {
            version: '1.0',
            exportDate: new Date().toISOString(),
            data: {}
        };
        
        // List of all keys we want to export
        const keysToExport = [
            'tasks',
            'taskStats',
            'emotionLogs',
            'timerActivityLog',
            'timerMuted',
            'links',
            'projects',
            'timezones',
            'pinnedTimezoneIndex',
            'tactics',
            'notes'
        ];
        
        // Collect data from localStorage
        keysToExport.forEach(key => {
            const value = localStorage.getItem(key);
            if (value !== null) {
                try {
                    // Try to parse JSON, if it fails, store as string
                    allData.data[key] = JSON.parse(value);
                } catch (e) {
                    // If it's not JSON (like 'notes'), store as string
                    allData.data[key] = value;
                }
            }
        });
        
        // Create JSON blob
        const jsonString = JSON.stringify(allData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        
        // Create download link
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        a.href = url;
        a.download = `control-panel-backup-${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Show success message
        alert('Data exported successfully!');
        hideDataManagement();
    } catch (error) {
        console.error('Error exporting data:', error);
        alert('Error exporting data. Please check the console for details.');
    }
}

function importLocalStorage(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // Validate structure
            if (!importedData.data || typeof importedData.data !== 'object') {
                throw new Error('Invalid backup file format');
            }
            
            // Confirm before overwriting
            if (!confirm('This will overwrite all current data. Are you sure?')) {
                return;
            }
            
            // Import each key
            Object.keys(importedData.data).forEach(key => {
                const value = importedData.data[key];
                if (typeof value === 'string') {
                    localStorage.setItem(key, value);
                } else {
                    localStorage.setItem(key, JSON.stringify(value));
                }
            });
            
            alert('Data imported successfully! Page will reload.');
            location.reload();
        } catch (error) {
            console.error('Error importing data:', error);
            alert('Error importing data. Please check the file format.');
        }
    };
    reader.readAsText(file);
    
    // Reset file input
    event.target.value = '';
}

// Close the modal when clicking anywhere outside of it
window.onclick = function(event) {
    if (event.target == document.getElementById('taskConfigModal')) {
        hideTaskConfig();
    }
    if (event.target == document.getElementById('linkConfigModal')) {
        hideLinkConfig();
    }
    if (event.target == document.getElementById('projectConfigModal')) {
        hideProjectConfig();
    }
    if (event.target == document.getElementById('timezoneConfigModal')) {
        hideTimezoneConfig();
    }
    if (event.target == document.getElementById('tacticsConfigModal')) {
        hideTacticsConfig();
    }
    if (event.target == document.getElementById('dataManagementModal')) {
        hideDataManagement();
    }
        }
    </script>
</body>
</html>
